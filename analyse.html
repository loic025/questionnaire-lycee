<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse des r√©sultats - Acc√®s prot√©g√©</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    .filters { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .chart-container { margin: 20px 0; }
    #auth { text-align: center; margin-top: 100px; }
    input[type=password] { padding: 5px; font-size: 1rem; }
    button { padding: 8px 16px; font-size: 1rem; margin: 5px; }
    table.synthese, table.synthese td, table.synthese th {
      border: 1px solid #333;
      border-collapse: collapse;
      text-align: center;
      padding: 6px;
    }
    table.synthese {
      margin: 20px auto;
      background-color: #fff;
    }
    .cell-yellow { background-color: #fdf5b5; }
    .cell-green { background-color: #c9f7c3; }
    .cell-grey { background-color: #d3d3d3; }
    .highlight { border: 3px solid red; font-weight: bold; }
    .summary-boxes {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .summary-box {
      border: 2px solid #ccc;
      padding: 10px;
      text-align: center;
      width: 150px;
      font-weight: bold;
      background: #f9f9f9;
    }
      #chartsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .chart-box {
      flex: 1 1 250px;
      max-width: 250px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="auth">
    <h2>Connexion requise</h2>
    <p>Mot de passe :</p>
    <input type="password" id="passwordInput">
    <button id="validerBtn">Valider</button>
    <p id="authError" style="color:red;"></p>
  </div>

  <div id="content" style="display:none">
    <h1>Analyse des r√©sultats</h1>

    <div style="text-align:right; margin-bottom: 20px;">
      <button onclick="exportCSV()">üì• Exporter toutes les r√©ponses</button>
      <button onclick="exportFilteredCSV()">üéØ Exporter r√©ponses filtr√©es</button>
      <button onclick="window.print()">üìÑ Exporter en PDF</button>
      <button id="resetButton" onclick="resetData()">üóë R√©initialiser les donn√©es</button>
      <button id="reloadDataBtn" class="reload-btn">üîÑ Recharger les donn√©es</button>
    </div>

    <div class="filters">
      <label>Classe :
        <select id="filterClasse">
          <option value="">Toutes</option>
      <option>2nde1</option>
      <option>2nde2</option>
      <option>1√®re1</option>
      <option>1√®re2</option>
      <option>Tle1</option>
      <option>Tle2</option>
      <option>2AGORA</option>
      <option>2ASSP</option>
      <option>2HRCUI</option>
      <option>2MTNE</option>
      <option>2MV</option>
      <option>1AGORA</option>
      <option>1ASSP</option>
      <option>1CIEL</option>
      <option>1MELEC</option>
      <option>1MV</option>
      <option>TAGORA</option>
      <option>TASSP</option>
      <option>TCIEL</option>
      <option>TCUI</option>
      <option>TMELEC</option>
      <option>TMV</option>
      <option>CAP1 EPC</option>
      <option>CAP1 IMTB</option>
      <option>CAP1 MV</option>
      <option>CAP2 CHB</option>
      <option>CAP2 CUI</option>
      <option>CAP2 EPC</option>
      <option>CAP2 IMTB</option>
        </select>
      </label>
      <label>Sexe :
        <select id="filterSexe">
          <option value="">Tous</option>
          <option>F</option>
          <option>M</option>
          <option>Autre</option>
        </select>
      </label>
        <label>Ann√©e :
  <select id="filterAnnee">
    <option value="">Toutes</option>
    <option>2011 ou apr√®s</option>
    <option>2010</option>
    <option>2009</option>
    <option>2008</option>
    <option>2007 ou avant</option>
  </select>
</label>
      <label>√âl√®ve :
        <select id="filterEleve"></select>
      </label>
      <label>Question :
        <select id="filterQuestion"></select>
      </label>
    </div>

    <div id="summaryBoxes" class="summary-boxes"></div>
    <div id="synthese"></div>
    <div id="chartsContainer"></div>
  </div>


  <script>
    let allData = [];
    const yesNoQuestions = Array.from({length: 10}, (_, i) => 35 + i); // q35 √† q44

     const questionLabels = [
      "As-tu peur sur le trajet du lyc√©e √† cause d‚Äôun ou plusieurs √©l√®ves ?",
      "As-tu peur d‚Äôaller au lyc√©e √† cause d‚Äôun ou plusieurs √©l√®ves ?",
      "As-tu menti pour rester chez toi par peur de retrouver un ou plusieurs √©l√®ves au lyc√©e ?",
      "As-tu s√©ch√© les cours √† cause de tes relations avec un ou plusieurs √©l√®ves ?",
      "Tes notes baissent-elles √† cause de ce que tu vis au lyc√©e ?",
      "Te sens-tu d√©motiv√©(e) √† cause de ce que tu vis au lyc√©e ?",
      "As-tu du mal √† faire tes devoirs √† cause de ce que tu vis au lyc√©e ?",
      "As-tu du mal √† t‚Äôendormir ou fais-tu des cauchemars √† cause de ce que tu vis au lyc√©e ?",
      "As-tu mal au ventre ou √† la t√™te √† cause de ce que tu vis au lyc√©e ?",
      "Est-ce que tu te sens triste √† cause de ce que tu vis au lyc√©e ?",
      "Est-ce que tu te sens seul(e) au lyc√©e ?",
      "As-tu peur d‚Äôaller en r√©cr√©ation √† cause d‚Äôun ou plusieurs √©l√®ves ?",
      "Te mets-tu en col√®re ou es-tu agressif(ve) sans savoir pourquoi ?",
      "Es-tu exclu(e) des groupes de travail par un ou plusieurs √©l√®ves ?",
      "As-tu √©t√© mis(e) √† l‚Äô√©cart dans la cour par un ou plusieurs √©l√®ves ?",
      "Manges-tu seul quand tu manges au lyc√©e ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves t‚Äôemp√™chent de manger tranquillement au lyc√©e ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves se moquent de toi ou t‚Äôinsultent ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves font courir des rumeurs sur toi ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves te rabaissent ou t‚Äôhumilient ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves t‚Äôont d√©j√† menac√©(e) ?",
      "T‚Äôes-tu bagarr√©(e) avec un ou plusieurs √©l√®ves ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves t‚Äôont bouscul√©(e) volontairement ?",
      "As-tu √©t√© agress√©(e) physiquement par un ou plusieurs √©l√®ves ?",
      "Est-ce qu‚Äôun ou plusieurs √©l√®ves t‚Äôont vol√© des affaires ou ont menac√© de le faire ?",
      "As-tu particip√© √† un jeu dangereux √† la demande d‚Äôun ou plusieurs √©l√®ves ?",
      "As-tu √©t√© emb√™t√©(e) aux toilettes ?",
      "Est-ce qu‚Äôon a essay√© de te retirer tes habits ?",
      "As-tu re√ßu des messages insultants ou mena√ßants en ligne ?",
      "Un ou plusieurs √©l√®ves font-ils circuler des photos ou messages sans ton accord ?",
      "Des photos ou vid√©os intimes de toi ont-elles circul√© sans ton accord ?",
      "Tes coordonn√©es ont-elles circul√© sans ton accord ?",
      "Es-tu victime d‚Äôinsultes √† caract√®re sexuel de la part d'un ou plusieurs √©l√®ves sur t√©l√©phone portable, sur les r√©seaux sociaux ou sur une plateforme de jeux en ligne ?",
      "As-tu subi des violences √† caract√®re sexuel (attouchements, baisers forc√©s, voyeurisme etc) de la part d'un ou plusieurs √©l√®ves ?",
      "Est-ce toujours par le ou les m√™mes √©l√®ves ?",
      "As-tu d√©j√† demand√© de l'aide √† un(e) autre √©l√®ve ?",
      "As-tu d√©j√† demand√© de l'aide √† tes parents ?",
      "As-tu d√©j√† demand√© de l'aide √† un personnel √©ducatif ?",
      "As-tu au moins un(e) ami(e) dans ton √©tablissement ?",
      "Connais-tu le num√©ro de t√©l√©phone contre le harc√®lement 3018 ?",
      "Si oui, as-tu d√©j√† appel√© ou as-tu eu l'intention de le faire ?",
      "As-tu d√©j√†, avec d'autres √©l√®ves, emb√™t√© un(e) autre √©l√®ve en te moquant de lui ou d'elle, en r√©p√©tant des rumeurs √† son sujet, en le ou la bousculant ou en le ou la mettant √† l'√©cart ?",
      "Connais-tu un(e) √©l√®ve harc√©l√©(e) dans ton √©tablissement ?",
      "Connais-tu un(e) √©l√®ve harcel√©(e) dans ta classe ?"
    ];

 let activeCharts = [];
    
    function renderCharts(data) {
      const container = document.getElementById("chartsContainer");
      // üßπ 1Ô∏è‚É£ Supprimer les anciens graphiques
  if (activeCharts.length) {
    activeCharts.forEach(chart => {
      try { chart.destroy(); } catch (e) {}
    });
    activeCharts = [];
  }

  // üßπ 2Ô∏è‚É£ Nettoyer le conteneur
  container.innerHTML = "";

  // üö® 3Ô∏è‚É£ Si pas de donn√©es, message et retour
  if (!data || !data.length) {
    container.innerHTML = "<p style='color:red; text-align:center;'>Aucune donn√©e disponible pour ce filtre.</p>";
    return;
  }

  // üî¢ 4Ô∏è‚É£ D√©terminer les questions √† afficher
  const questionValue = parseInt(document.getElementById("filterQuestion").value || "0");
  const questionsToRender = questionValue ? [questionValue] : Array.from({ length: 44 }, (_, i) => i + 1);

  // üîÅ 5Ô∏è‚É£ Boucle sur chaque question
  for (const q of questionsToRender) {
    // üü¢ Cas 1 : Oui/Non
    if (q >= 35 && q <= 44) {
      const oui = data.filter(r => (r[`q${q}`] || "").toString().toLowerCase() === "oui").length;
      const non = data.filter(r => (r[`q${q}`] || "").toString().toLowerCase() === "non").length;

      const chartBox = document.createElement("div");
      chartBox.classList.add("chart-box");
      chartBox.innerHTML = `<canvas id="chartQ${q}" width="200" height="200"></canvas>`;
      container.appendChild(chartBox);

       const chart = new Chart(document.getElementById(`chartQ${q}`).getContext("2d"), {
        type: "pie",
        data: { labels: ["Oui", "Non"], datasets: [{ data: [oui, non] }] },
        options: {
          plugins: {
            title: { display: true, text: questionLabels[q - 1] },
            legend: { position: "bottom" }
          }
        }
      });

      activeCharts.push(chart);
      continue;
    }

    // üîµ Cas 2 : Questions √† 4 choix (1 √† 34)
    const counts = [0, 0, 0, 0];
    data.forEach(r => {
      const val = (r[`q${q}`] || "").toString().trim();
      if (["1", "2", "3", "4"].includes(val)) counts[parseInt(val, 10) - 1]++;
    });

    const chartBox = document.createElement("div");
    chartBox.classList.add("chart-box");
    chartBox.innerHTML = `<canvas id="chartQ${q}" width="200" height="200"></canvas>`;
    container.appendChild(chartBox);

      const ctx = document.getElementById(`chartQ${q}`).getContext("2d");
    const chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["1", "2", "3", "4"],
        datasets: [{ data: counts }]
      },
      options: {
        plugins: {
          title: { display: true, text: questionLabels[q - 1] },
          legend: { position: "bottom" }
        }
      }
    });

    activeCharts.push(chart);
  }
}
    async function resetData() {
      if (!confirm("‚ö†Ô∏è Es-tu s√ªr(e) de vouloir effacer TOUTES les donn√©es du fichier ?")) return;

      const response = await fetch("/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: PASSWORD })
      });

      const result = await response.json();
      if (result.status === "ok") {
        alert("‚úÖ Les donn√©es ont √©t√© effac√©es avec succ√®s !");
        loadData();
      } else {
        alert("‚ùå Erreur : " + (result.message || "Impossible de r√©initialiser."));
      }
    }
async function loadData() {
  const res = await fetch('/data_lycee_sheet'); // ‚úÖ lecture depuis Google Sheets
  const rows = await res.json();

  const filterEleve = document.getElementById("filterEleve");
  const previousEleve = filterEleve.value;
  filterEleve.innerHTML = '<option value="">Tous</option>' + rows.map((r, i) => {
    const nom = r.nomEleve && r.nomEleve.trim() !== "" ? r.nomEleve : `√âl√®ve ${i + 1}`;
    let classe = r.classe;
    if (classe !== undefined && classe !== null) {
      classe = "'" + String(classe).replace(".0", "").trim();
    }
    classe = classe.replace(/^'/, "");
    const label = `${nom} ‚Äì ${classe || "?"} ‚Äì ${r.sexe || "?"} ‚Äì ${r.annee || ""}`;
    return `<option value="${i}">${label}</option>`;
  }).join('');
  filterEleve.value = previousEleve;

  // Initialisation du filtre des questions si pas encore fait
  const filterQuestion = document.getElementById("filterQuestion");
  if (filterQuestion.length === 0) {
    filterQuestion.innerHTML = '<option value="">Toutes</option>';
    questionLabels.forEach((q, i) => {
      const opt = document.createElement("option");
      opt.value = i + 1;
      opt.textContent = q;
      filterQuestion.appendChild(opt);
    });
  }

  const questionValue = filterQuestion.value;
  const classe = document.getElementById('filterClasse').value;
  const sexe = document.getElementById('filterSexe').value;
  const eleveIndex = filterEleve.value;
  const annee = document.getElementById('filterAnnee').value;

  // üîπ Normalisation texte pour comparaison plus fiable
  const norm = (s) => (s || "").toString().trim().toLowerCase().replace(/\s+/g, "");

  let filtered;

  if (eleveIndex !== "") {
    filtered = [rows[parseInt(eleveIndex)]];
  } else {
    filtered = rows.filter(row =>
      (!classe || norm(row.classe) === norm(classe)) &&
      (!sexe || norm(row.sexe) === norm(sexe)) &&
      (!annee || norm(row.annee) === norm(annee))
    );
  }

  const container = document.getElementById("chartsContainer");
  const syntheseBlock = document.getElementById("synthese");
  const summaryBoxes = document.getElementById("summaryBoxes");

  // üßπ Nettoyage avant affichage
  syntheseBlock.innerHTML = "";
  summaryBoxes.innerHTML = "";
  container.innerHTML = "";

  // üö® Aucun r√©sultat pour la combinaison de filtres
  if (!filtered || filtered.length === 0) {
    activeCharts.forEach(chart => chart.destroy());
    activeCharts = [];
    container.innerHTML = "<p style='color:red; text-align:center;'>Aucune donn√©e disponible pour ce filtre.</p>";
    return;
  }

  // ‚úÖ Si un √©l√®ve unique s√©lectionn√© ‚Üí affiche la synth√®se A/B/C
  if (eleveIndex !== "") {
    syntheseBlock.style.display = "block";
    computeTableSynthese(filtered);
  } else {
    syntheseBlock.style.display = "none";
  }

  // ‚úÖ Enfin, on affiche les graphiques
  renderCharts(filtered);
}
  
function renderChart(canvas, data, questionIndex) {
  new Chart(canvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: ['1', '2', '3', '4'],
      datasets: [{
         label: `Question ${questionIndex}`,
         data: data,
         backgroundColor: ['#66bb6a', '#ffa726', '#ef5350', '#ab47bc']
       }]
     },
     options: {
       responsive: false,
       plugins: {
         title: {
           display: true,
           text: `Question ${questionIndex}`}
        }
      }
    });
  }
    function showSummaryBoxes(a, b, c) {
      document.getElementById("summaryBoxes").innerHTML = `
        <div class="summary-box">Total A<br><span>${a}</span></div>
        <div class="summary-box">Total B<br><span>${b}</span></div>
        <div class="summary-box">Total C<br><span>${c}</span></div>
      `;
    }

    function getValidationMessage(totalA, totalBC) {
      let row, col;

      if (totalA === 0) row = 0;
      else if (totalA <= 2) row = 1;
      else if (totalA <= 5) row = 2;
      else row = 3;

      if (totalBC === 0) col = 0;
      else if (totalBC <= 2) col = 1;
      else if (totalBC <= 4) col = 2;
      else col = 3;

      const zoneColor = [
    ["white", "white", "grey", "yellow"],
    ["white", "white", "grey", "yellow"],
    ["grey", "grey", "grey", "yellow"],
    ["yellow", "yellow", "yellow", "yellow"]
      ][row][col];

      if (zoneColor === "white") {
        return "üü¢ √âl√®ve en situation rassurante.";
      } else if (zoneColor === "grey") {
        return "üü° √âl√®ve dans une situation √† surveiller.";
      } else {
        return "‚ö´ √âl√®ve en situation de harc√®lement.";
      }
    }
    function computeTableSynthese(rows) {
      document.getElementById('synthese').innerHTML = "";

      let totalA = 0, totalB = 0, totalC = 0;
      rows.forEach(r => {
        for (let i = 2; i <= 11; i++) {
          const val = parseInt(r[`q${i}`]);
          if (val === 3 || val === 4) totalA++;
        }
        for (let i = 14; i <= 30; i++) {
          const val = parseInt(r[`q${i}`]);
          if (val === 3 || val === 4) totalB++;
        }
        for (let i = 31; i <= 34; i++) {
          const val = parseInt(r[`q${i}`]);
          if (val === 2 || val === 3 || val === 4) totalC++;
        }
      });
    const summary = document.getElementById("summaryBoxes");
if (rows.length === 1) {
  summary.style.display = "flex";
  showSummaryBoxes(totalA, totalB, totalC);
} else {
  summary.style.display = "none";
  }
    const totalBC = totalB + totalC;
    const message = getValidationMessage(totalA, totalBC);
    let row, col;
if (totalA === 0) row = 0;
else if (totalA <= 2) row = 1;
else if (totalA <= 5) row = 2;
else row = 3;

if (totalBC === 0) col = 0;
else if (totalBC <= 2) col = 1;
else if (totalBC <= 4) col = 2;
else col = 3;
    const couleurs = {
  white: 'background-color: white;',
  grey: 'background-color: #d3d3d3;',
  yellow: 'background-color: #fdf5b5;'
};

let table = `<table class="synthese"><tr><th></th><th>0</th><th>1-2</th><th>3-4</th><th>5+</th></tr>`;

const lignes = ["0", "1-2", "3-5", "6 ou plus"];
const zoneColorMatrix = [
  ["white", "white", "grey", "yellow"],
  ["white", "white", "grey", "yellow"],
  ["grey", "grey", "grey", "yellow"],
  ["yellow", "yellow", "yellow", "yellow"]
];

for (let i = 0; i < 4; i++) {
  table += `<tr><th>${lignes[i]}</th>`;
  for (let j = 0; j < 4; j++) {
    const color = zoneColorMatrix[i][j];
    const highlight = (i === row && j === col) ? 'border: 3px solid red; font-weight: bold;' : '';
    const check = (i === row && j === col) ? '‚úîÔ∏è' : '';
    table += `<td style="${couleurs[color]} ${highlight} width: 60px; height: 30px;">${check}</td>`;
  }
  table += `</tr>`;
}
table += `</table>`;

document.getElementById('synthese').insertAdjacentHTML('beforeend', table);
document.getElementById('synthese').insertAdjacentHTML('beforeend', `<p style="text-align: center;"><strong>${message}</strong></p>`);
    }

    document.getElementById("filterClasse").addEventListener("change", loadData);
    document.getElementById("filterSexe").addEventListener("change", loadData);
    document.getElementById("filterQuestion").addEventListener("change", loadData);
    document.getElementById("filterEleve").addEventListener("change", loadData);
    document.getElementById("filterAnnee").addEventListener("change", loadData);

    // üÜï Bouton "Recharger les donn√©es"
document.getElementById("reloadDataBtn").addEventListener("click", async () => {
  const btn = document.getElementById("reloadDataBtn");
  btn.disabled = true;
  btn.textContent = "‚è≥ Rechargement...";
  await loadData();
  btn.textContent = "üîÑ Recharger les donn√©es";
  btn.disabled = false;
});
function exportCSV() {
  fetch('/data')
    .then(response => response.json())
    .then(rows => {
      if (!rows || rows.length === 0) return alert("Aucune donn√©e √† exporter.");
      
      const headers = ["nomEleve", "classe", "sexe", "annee"];
for (let i = 1; i <= 44; i++) {
  headers.push(`q${i}`);
}
      const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => `"${r[h]}"`).join(","))).join("\n");

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "donnees.csv";
      link.click();
      URL.revokeObjectURL(url);
    });
}
function exportFilteredCSV() {
  fetch('/data')
    .then(response => response.json())
    .then(rows => {
      const classe = document.getElementById('filterClasse').value;
      const sexe = document.getElementById('filterSexe').value;
      const eleveIndex = document.getElementById('filterEleve').value;

      let filtered;
      if (eleveIndex !== "") {
        filtered = [rows[parseInt(eleveIndex)]];
      } else {
        filtered = rows.filter(row =>
          (!classe || row.classe === classe) &&
          (!sexe || row.sexe === sexe)
        );
      }

      if (!filtered || filtered.length === 0) {
        alert("Aucune donn√©e filtr√©e √† exporter.");
        return;
      }

     const headers = ["nomEleve", "classe", "sexe", "annee"];
for (let i = 1; i <= 44; i++) {
  headers.push(`q${i}`);
}
      const csv = [headers.join(",")].concat(filtered.map(r =>
        headers.map(h => `"${r[h]}"`).join(",")
      )).join("\n");

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "reponses_filtrees.csv";
      link.click();
      URL.revokeObjectURL(url);
    });
}
    async function resetData() {
  const pwd = prompt("Entrez le mot de passe enseignant pour effacer toutes les donn√©es :");
  if (!pwd) return;
  const res = await fetch("/reset", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({password: pwd})
  });
  const data = await res.json();
  alert(data.message);
  if (data.status === "ok") location.reload();
}
  function checkPassword() {
  const pwd = document.getElementById('passwordInput').value;
  if (pwd === 'enseignant2024') {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    loadData();
  } else {
    document.getElementById('authError').textContent = 'Mot de passe incorrect.';
  }
}
document.getElementById('validerBtn').addEventListener('click', checkPassword);  
</script>
</body>
</html>
